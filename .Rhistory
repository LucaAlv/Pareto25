library(tidyverse)
######## This file does all preprocessing of the Census Data ########
#### Load packages ####
library(tidyverse)
library(ipumsr)
#### Load Census Data ####
census_ddi <- read_ipums_ddi("Data/IPUMS/Census_Data/ipumsi_00002.xml")
census_data_raw <- read_ipums_micro(census_ddi)
state_nodes_preprocess <- census_data_raw %>%
janitor::clean_names() %>%
select(perwt, hhwt, geolev1, year, incearn, popdensgeo2, areamollwgeo2) %>%
filter(year == 2020) %>%
mutate(
popdensgeo2 = ifelse(popdensgeo2 == 0, NA_real_, popdensgeo2),
areamollwgeo2 = ifelse(areamollwgeo2 == 0, NA_real_, areamollwgeo2),
incearn = ifelse(incearn %in% c(99999999, 99999998), NA_real_, incearn),
mun_pop = sum(perwt, na.rm = TRUE)
) %>%
group_by(geolev1, year) %>%
summarise(
mean_inc = weighted.mean(incearn, perwt, na.rm = TRUE),
mun_pop = first(mun_pop),
state_pop = sum(mun_pop),
.groups = "drop"
)
saveRDS(state_nodes_preprocess, "Data/temp/state_nodes_preprocess")
cat("Processed and saved pre process state level census data\n")
rm(state_nodes_preprocess)
gc()
#### Formatting NAs correctly for geolevel2 ####
census_data <- census_data_raw %>%
janitor::clean_names() %>%
rename(geolevel2 = geolev2, geolevel1 = geolev1) %>%
mutate(
geolevel2 = as.character(geolevel2),
geolevel2 = if_else(
geolevel2 %in% c(
"484001999", "484002999", "484003999", "484004999", "484005999", "484006999",
"484007999", "484008999", "484009999", "484010999", "484011999", "484012999",
"484013999", "484014999", "484015999", "484016999", "484017999", "484018999",
"484019999", "484020999", "484021999", "484022999", "484023999", "484024999",
"484025999", "484026999", "484027999", "484028999", "484029999", "484030999"
),
NA_character_,
geolevel2
)
)
rm(census_data_raw)
saveRDS(census_data, "Data/temp/census_data.rds")
